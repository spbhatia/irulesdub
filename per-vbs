Sub RunHealthCheck()
    Dim lastRow As Long
    Dim i As Long
    Dim server, path, port, fqdn, proto As String
    Dim result As String
    Dim shellOutput As String
    Dim curlCmd As String
    Dim tempFile As String
    
    ' Determine last used row in Column G (Server Name)
    lastRow = Cells(Rows.Count, "G").End(xlUp).Row
    
    For i = 6 To lastRow
        server = Cells(i, "G").Value
        path = Cells(i, "M").Value
        port = Cells(i, "I").Value
        fqdn = Cells(i, "E").Value
        proto = UCase(Trim(Cells(i, "K").Value))
        
        ' Skip empty rows
        If server = "" Then GoTo NextRow
        
        tempFile = Environ("TEMP") & "\curl_output.txt"
        
        ' Check protocol type
        If proto = "TCP" Then
            result = CheckTCP(server, port, tempFile)
        ElseIf proto = "HTTP" Or proto = "HTTPS" Then
            result = CheckHTTP(server, path, port, fqdn, proto, tempFile)
        Else
            result = "Unknown protocol: " & proto
        End If
        
        ' Write result to Column N
        Cells(i, "N").Value = result
        
NextRow:
    Next i
    
    MsgBox "Health Check Completed!"
End Sub

Function CheckTCP(server As String, port As String, tempFile As String) As String
    Dim curlCmd As String
    Dim shellOutput As String
    
    ' TCP connectivity check using curl telnet
    curlCmd = "cmd /c curl -v --connect-timeout 5 telnet://" & server & ":" & port & " > """ & tempFile & """ 2>&1"
    
    Shell curlCmd, vbHide
    Application.Wait (Now + TimeValue("0:00:03"))
    
    shellOutput = ReadFile(tempFile)
    
    If InStr(shellOutput, "Connected to") > 0 Then
        CheckTCP = "TCP Connected"
    ElseIf InStr(shellOutput, "Connection refused") > 0 Then
        CheckTCP = "TCP Connection refused"
    ElseIf InStr(shellOutput, "timed out") > 0 Then
        CheckTCP = "TCP Connection timeout"
    Else
        CheckTCP = "TCP Connection failed"
    End If
End Function

Function CheckHTTP(server As String, path As String, port As String, fqdn As String, proto As String, tempFile As String) As String
    Dim curlCmd As String
    Dim shellOutput As String
    Dim url As String
    Dim hostHeader As String
    
    url = proto & "://" & server & ":" & port & "/" & path
    hostHeader = "-H ""Host: " & fqdn & """"
    
    ' HEAD Method with Host Header
    curlCmd = "cmd /c curl -I -k --connect-timeout 10 """ & url & """ " & hostHeader & " > """ & tempFile & """ 2>&1"
    
    Shell curlCmd, vbHide
    Application.Wait (Now + TimeValue("0:00:03"))
    
    shellOutput = ReadFile(tempFile)
    
    If InStr(shellOutput, "200") > 0 Then
        CheckHTTP = "Health check status is Up"
    
    ElseIf InStr(shellOutput, "401") > 0 Then
        CheckHTTP = "Authentication is on preventing server Health check"
    
    ElseIf InStr(shellOutput, "404") > 0 Then
        ' Try HEAD without Host Header
        curlCmd = "cmd /c curl -I -k --connect-timeout 10 """ & url & """ > """ & tempFile & """ 2>&1"
        Shell curlCmd, vbHide
        Application.Wait (Now + TimeValue("0:00:03"))
        shellOutput = ReadFile(tempFile)
        
        If InStr(shellOutput, "200") > 0 Then
            CheckHTTP = "Health check status is Up"
        Else
            CheckHTTP = "Health check status is Down (404)"
        End If
        
    ElseIf InStr(shellOutput, "405") > 0 Then
        ' Try GET method
        curlCmd = "cmd /c curl -i -k --connect-timeout 10 """ & url & """ " & hostHeader & " > """ & tempFile & """ 2>&1"
        Shell curlCmd, vbHide
        Application.Wait (Now + TimeValue("0:00:03"))
        shellOutput = ReadFile(tempFile)
        
        If InStr(shellOutput, "200") > 0 Then
            CheckHTTP = "Http HEAD method is not permitted, GET method is permitted"
        Else
            CheckHTTP = "Health check status is Down"
        End If
    
    ElseIf InStr(shellOutput, "(7)") > 0 Or InStr(shellOutput, "(35)") > 0 Or InStr(shellOutput, "(60)") > 0 Then
        ' Try http instead of https
        If proto = "HTTPS" Then
            url = "http://" & server & ":" & port & "/" & path
            curlCmd = "cmd /c curl -I -k --connect-timeout 10 """ & url & """ " & hostHeader & " > """ & tempFile & """ 2>&1"
            Shell curlCmd, vbHide
            Application.Wait (Now + TimeValue("0:00:03"))
            shellOutput = ReadFile(tempFile)
            
            If InStr(shellOutput, "200") > 0 Then
                CheckHTTP = "Health check status is down on https, Up on http"
            Else
                CheckHTTP = "Health check status is Down (HTTPS errors persist)"
            End If
        Else
            CheckHTTP = "Health check status is Down"
        End If
        
    Else
        CheckHTTP = "Health check status indeterminate"
    End If
End Function

Function ReadFile(filePath As String) As String
    Dim fileNo As Integer
    Dim fileContent As String
    
    On Error Resume Next
    fileNo = FreeFile
    Open filePath For Input As #fileNo
    fileContent = Input$(LOF(fileNo), fileNo)
    Close #fileNo
    ReadFile = fileContent
End Function
